!function(a){zip.useWebWorkers=!1;var b=function(a){return a.filter(function(a){return"string"!=typeof a}).length<1},c=function(){var a=[],b=function(){a.shift(),a.length>0&&a[0](b)};return new ArrayObserver(a,function(c){a.length>0&&0===a.length-c[0].addedCount&&a[0](b)}),a},d=function(a,b,c){function d(a){var d=f.config.templatePath+a,g=new XMLHttpRequest;g.responseType="text",g.open("GET",d,!0),g.send(),g.onload=function(){if("200"==this.status){var g=a.slice(0,a.indexOf(".")>0?a.indexOf("."):a.length-1),h=!1;new RegExp(b.join("|")).test(a)||(h=Handlebars.compile(this.response)),f.templates[g]=h||this.response,Object.keys(f.templates).length===e.length&&c()}else new Error("Book() loadTemplate: Could not load template from path ",d)}}if(Object.keys(f.templates).length>0)return c(),void 0;b=b||[];for(var e=a.concat(b),g=e.length-1;g>=0;g--)d(e[g])},e=function(a){var b=this,c=new zip.fs.FS,d=c.root.addDirectory("META-INF"),e=c.root.addDirectory("OEBPS");b.book=e,c.root.addText("mimetype","application/epub+zip"),d.addBlob("container.xml",new Blob(['<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>'],{type:"application/xml"})),e.addBlob("content.opf",new Blob([f.templates.content({title:b.title,author:b.author,chapters:b.chapters,lang:b.language,uuid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})})],{type:"application/oebps-package+xml"})),e.addBlob("title_page.xhtml",new Blob([f.templates.title_page({title:b.title,author:b.author})],{type:"application/xhtml+xml"})),e.addText("style.css",f.templates.style),b._zip=c,a()};Handlebars.registerHelper("chapter",function(a){return parseInt(a,10)+1}),Handlebars.registerHelper("html",function(a){return new Handlebars.SafeString(a)});var f=function(){var a=this;if(!(a instanceof f))throw new Error("Book(): Function must be a new instance.");if("[object Object]"===Object.prototype.toString.call(arguments[0])){try{a.title=arguments[0].title,a.author=arguments[0].author}catch(g){}if("language"in arguments[0]){if(!/[a-z][a-z]-[A-Z][A-Z]/g.test(arguments[0].language))throw new Error("Book(): The language parameter must comply with RFC 3066 ex:en-US.");a.language=arguments[0].language}else a.language="en-US";a.chapters=[]}else{if(!(arguments[0]instanceof Array))throw new Error("Book(): First Argument must be an Object of Settings or an Array of Chapters.");if(!b(arguments[0]))throw new Error("Book(): The Array must contain only strings.");a.chapters=arguments[0],a.title=a.author=""}a._queue=new c,a._queue.push(d.bind(a,["content.opf","chapter.xhtml","title_page.xhtml"],["style.css"])),a._queue.push(e.bind(a))};f.prototype={exportBlob:function(a){var b=this;b._queue.push(function(){b._zip.root.exportBlob(function(b){a(b.slice(0,b.size,"application/epub+zip"))})})},addChapter:function(a){var b=this,c=function(a,c){if(a=f.templates.chapter({text:a,index:b.chapters.length}),f.config.validateXML&&(new DOMParser).parseFromString(a,"application/xhtml+xml").getElementsByTagName("parsererror").length>0)throw new Error("Book(): Invalid XHTML in chapters["+b.chapters.length+"]");b.book.addBlob("chap"+b.chapters.length+".xhtml",new Blob([a],{type:"application/xhtml+xml"})),b.chapters.push(a),c()};b._queue.push(c.bind(b,a))},addChapters:function(a){for(var b=0;b<a.length;b++)this.addChapter(a[b])},downloadBook:function(){var b=this;this._zip.root.exportBlob(function(c){a.saveAs(c,b.title+" - "+b.author+".epub")})}},f.config={},f.templates={},f.config.templatePath="templates/",f.config.validateXML=!0,a.Book=f}(this);