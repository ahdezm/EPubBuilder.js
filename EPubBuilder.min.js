!function(a){if(!("zip"in a))throw new Error("Book(): zip.js is a dependency of EPubBuilder.js");zip.useWebWorkers=!1;var b=function(){var a=[],b=function(){a.shift(),a.length>0&&a[0](b)};return new ArrayObserver(a,function(c){a.length>0&&0===a.length-c[0].addedCount&&a[0](b)}),a},c=function(a){if(Object.keys(e.templates).length>0)return a(),void 0;var b=new XMLHttpRequest;b.responseType="text",b.open("GET",e.config.templateJSON,!0),b.send(),b.onload=function(){if("200"==this.status){try{e.templates=JSON.parse(this.response)}catch(b){throw new Error("Book() loadJSON: Uable to parse "+e.config.templateJSON+" JSON file.")}for(var c in e.templates)e.config.templateCompile.indexOf(c)>-1&&(e.templates[c]=Handlebars.compile(e.templates[c]));a()}else new Error("Book() loadJSON: Could not load JSON template file from path ",e.config.templateJSON)}},d=function(a){var b=this,c=new zip.fs.FS,d=c.root.addDirectory("META-INF"),f=c.root.addDirectory("OEBPS");b.book=f,c.root.addText("mimetype","application/epub+zip"),d.addBlob("container.xml",new Blob(['<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>'],{type:"application/xml"})),f.addBlob("content.opf",new Blob([e.templates.content({title:b.title,author:b.author,chapters:b.chapters,lang:b.language,uuid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})})],{type:"application/oebps-package+xml"})),f.addBlob("title_page.xhtml",new Blob([e.templates.title_page({title:b.title,author:b.author})],{type:"application/xhtml+xml"})),f.addText("style.css",e.templates.style),b._zip=c,a()};Handlebars.registerHelper("chapter",function(a){return parseInt(a,10)+1}),Handlebars.registerHelper("html",function(a){return new Handlebars.SafeString(a)});var e=function(){var a=this;if(!(a instanceof e))throw new Error("Book(): Function must be a new instance.");if("[object Object]"!==Object.prototype.toString.call(arguments[0]))throw new Error("Book(): First Argument must be an Object of Settings.");try{a.title=arguments[0].title,a.author=arguments[0].author}catch(f){}if("language"in arguments[0]){if(!/[a-z][a-z]-[A-Z][A-Z]/g.test(arguments[0].language))throw new Error("Book(): The language parameter must comply with RFC 3066 ex:en-US.");a.language=arguments[0].language}else a.language="en-US";a._queue=new b,a._queue.push(c),a._queue.push(d.bind(a))};e.prototype={exportBlob:function(a){var b=this;b._queue.push(function(){b._zip.root.exportBlob(function(b){a(b.slice(0,b.size,"application/epub+zip"))})})},addChapter:function(a){var b=this,c=1,d=function(a,d){if(a=e.templates.chapter({text:a,index:c}),e.config.validateXML&&(new DOMParser).parseFromString(a,"application/xhtml+xml").getElementsByTagName("parsererror").length>0)throw new Error("Book(): Invalid XHTML in chapters["+b.chapters.length+"]");b.book.addBlob("chap"+c+".xhtml",new Blob([a],{type:"application/xhtml+xml"})),c++,d()};b._queue.push(d.bind(b,a))},addChapters:function(a){for(var b=0;b<a.length;b++)this.addChapter(a[b])}},e.config={},e.templates={},e.config.templateJSON="template.json",e.config.templateCompile=["content","chapter","title_page"],e.config.validateXML=!0,Object.preventExtensions(e.config),a.Book=e}(this);