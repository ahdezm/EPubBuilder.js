!function(a){if(!("zip"in a))throw new Error("Book(): zip.js is a dependency of EPubBuilder.js");zip.useWebWorkers=!1;var b=function(){var a=[],b=function(){a.shift(),a.length>0&&a[0](b)};return a.push=function(a){Array.prototype.push.call(this,a),1===this.length&&this[0](b)},a},c=function(a){if(Object.keys(f.templates).length>0)return a(),void 0;var b=new XMLHttpRequest;b.responseType="text",b.open("GET",f.config.templateJSON,!0),b.send(),b.onload=function(){if("200"==this.status){try{f.templates=JSON.parse(this.response)}catch(b){throw new Error("Book() loadJSON: Uable to parse "+f.config.templateJSON+" JSON file.")}for(var c in f.templates)f.config.templateCompile.indexOf(c)>-1&&(f.templates[c]=Handlebars.compile(f.templates[c]));a()}else new Error("Book() loadJSON: Could not load JSON template file from path ",f.config.templateJSON)}},d=function(a){var b=this,c=new zip.fs.FS,d=c.root.addDirectory("META-INF"),e=c.root.addDirectory("OEBPS");b.book=e,c.root.addText("mimetype","application/epub+zip"),d.addBlob("container.xml",new Blob(['<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>'],{type:"application/xml"})),e.addBlob("title_page.xhtml",new Blob([f.templates.title_page({title:b.title,author:b.author})],{type:"application/xhtml+xml"})),e.addText("style.css",f.templates.style),b.book.chaptersAdded=1,b._zip=c,a()},e=function(a){for(var b=[],c=1;c<=this.book.chaptersAdded;c++)b.push(c);this.book.addBlob("content.opf",new Blob([f.templates.content({title:this.title,author:this.author,chapters:b,lang:this.language,uuid:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})})],{type:"application/oebps-package+xml"})),a()};Handlebars.registerHelper("html",function(a){return new Handlebars.SafeString(a)});var f=function(){var a=this;if(!(a instanceof f))throw new Error("Book(): Function must be a new instance.");if("[object Object]"!==Object.prototype.toString.call(arguments[0]))throw new Error("Book(): First Argument must be an Object of Settings.");try{a.title=arguments[0].title,a.author=arguments[0].author}catch(e){}if("language"in arguments[0]){if(!/[a-z][a-z]-[A-Z][A-Z]/g.test(arguments[0].language))throw new Error("Book(): The language parameter must comply with RFC 3066 ex:en-US.");a.language=arguments[0].language}else a.language="en-US";a._queue=new b,a._queue.push(c),a._queue.push(d.bind(a))};f.prototype={exportBlob:function(a){var b=this;b._queue.push(e.bind(b)),b._queue.push(function(c){b._zip.root.exportBlob(function(b){a(b.slice(0,b.size,"application/epub+zip"))}),c()})},addChapter:function(a,b){var c=this,d=arguments,e=function(e){var g,h;if(2===d.length?(g=!isNaN(parseFloat(a))&&isFinite(a)?a:c.book.chaptersAdded,h=b.toString()):(h=a.toString(),g=c.book.chaptersAdded),h=f.templates.chapter({text:h,index:g}),f.config.validateXML&&(new DOMParser).parseFromString(h,"application/xhtml+xml").getElementsByTagName("parsererror").length>0)throw new Error("Book(): Invalid XHTML in chapter "+g);c.book.addBlob("chap"+g+".xhtml",new Blob([h],{type:"application/xhtml+xml"})),c.book.chaptersAdded++,e()};c._queue.push(e)},addChapters:function(a){for(var b=0;b<a.length;b++)this.addChapter(a[b])}},f.config={},f.templates={},f.config.templateJSON="template.json",f.config.templateCompile=["content","chapter","title_page"],f.config.validateXML=!0,Object.preventExtensions(f.config),a.Book=f}(this);